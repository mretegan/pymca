name: Windows (cx_freeze - installer)

on:
  workflow_dispatch:
  workflow_call:

env:
  PROJECT: PyMca5
  PROJECT_LOWER: pymca5

jobs:
# Fat binaries
  windows_cxfreeze_python313:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.13" #was working with cp3.9 and pyqt5 numpy==1.24.4 cx_freeze==6.14.7 qtconsole==5.4.1 lief==0.12.3 matplotlib==3.5.3

      - name: Install dependencies
        run: |          
          
          python -m pip install --upgrade pip setuptools wheel
          pip install qtconsole==5.6.1
          pip install matplotlib==3.10.5
          pip install lief==0.16.6
          pip install cx_Freeze==8.3.0
          pip install --pre --extra-index-url https://test.pypi.org/simple/ --trusted-host test.pypi.org --only-binary PyMca5 PyMca5
          pip install Cython
          pip install numpy==2.2.6 
          pip install Pyside6==6.9.1
          pip install h5py
          pip install fisx
          pip install hdf5plugin
          pip install silx==2.2.2
          pip install PyOpenGL
          pip install git+https://github.com/vasole/bcflight.git

      - name: Install NSIS
        run: choco install nsis -y

      - name: Add NSIS to PATH
        shell: pwsh
        run: |
          echo "C:/Program Files (x86)/NSIS" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Check makensis availability
        shell: pwsh
        run: |
          where makensis
          makensis /VERSION

      - name: Build with cx_Freeze
        shell: cmd
        run:
          python build-cxfreeze_github.py

      - name: Print dist* directories content with PowerShell
        shell: pwsh
        run: |
          Get-ChildItem -Directory -Name dist* | ForEach-Object {
            Write-Host "Contents of $_ :"
            Get-ChildItem -Path $_ -Recurse
          }

      - name: Install PyMca from installer
        shell: pwsh
        run: |
          # Find the installer
          $installer = Get-Item dist\pymca*.exe
          if (-not $installer) {
            Write-Error "Installer not found in dist/"
            exit 1
          }
          # Run installer silently (adjust /S as needed)
          Start-Process -FilePath $installer.FullName -ArgumentList "/S" -Wait

      - name: Run the installed app to check it launches
        shell: pwsh
        run: |
          # Define expected install path
          $basePaths = @(
              "${env:ProgramFiles}",
              "${env:ProgramFiles(x86)}"
          )
          $exeName = "PyMcaMain.exe"
          $appPath = $null
          
          #find exe (naming of folder with version)
          foreach ($base in $basePaths) {
              # Only search inside folders starting with PyMca*
              $candidateDirs = Get-ChildItem -Path $base -Directory -Filter "PyMca*" -ErrorAction SilentlyContinue
          
              foreach ($dir in $candidateDirs) {
                  $possiblePath = Join-Path $dir.FullName $exeName
                  if (Test-Path $possiblePath) {
                      $appPath = $possiblePath
                      break
                  }
              }
          
              if ($appPath) { break }
          }
          if (-not $appPath) {
              Write-Error "Executable '$exeName' not found in Program Files."
              exit 1
          }
          Write-Host "Found executable at $appPath"
          
          if (-not (Test-Path $appPath)) {
            Write-Error "App was not installed to expected path: $appPath"
            exit 1
          }
      
          Write-Host "Launching installed PyMcaMain..."
      
          # Launch app and monitor
          $process = Start-Process -FilePath $appPath -PassThru
          Write-Host "App started with PID $($process.Id)"
      
          $timeoutSeconds = 120
          $stopWatch = [System.Diagnostics.Stopwatch]::StartNew()
      
          while (-not $process.HasExited -and $stopWatch.Elapsed.TotalSeconds -lt $timeoutSeconds) {
            Start-Sleep -Seconds 1
          }
      
          if (-not $process.HasExited) {
            Write-Host "App ran for $timeoutSeconds seconds without crashing. Killing it now..."
            try {
              $process.Kill()
              $process.WaitForExit()
            } catch {
              Write-Warning "Failed to kill the process: $_"
            }
            Write-Host "App test complete."
            exit 0
          } else {
            $exitCode = $process.ExitCode
            if ($exitCode -ne 0) {
              Write-Error "App exited with error code $exitCode"
              exit $exitCode
            } else {
              Write-Error "App exited cleanly before $timeoutSeconds seconds, marking as failure."
              exit 1
            }
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-cxfreeze
          path: dist/*
          retention-days: 1
